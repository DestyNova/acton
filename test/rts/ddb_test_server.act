actor Tester(env, port):
    var lsock = None
    var i = 0

    def init_listen():
        s = env.listen(port, connect_handler, sock_err_handler)
        return s

    def sock_err_handler(lsock):
        print("Error with our listening socket, attempting to re-establish listening socket")
        lsock = init_listen()

    def recv_handler(conn, msg):
        print("RECV", conn, msg)
        if msg == "GET":
            conn.write(str(i))
        if msg == "INC":
            i += 1
            conn.write("OK")

    def err_handler(conn, msg):
        pass

    def connect_handler(conn : Connection):
        print("Got connection")
        conn.on_receive(recv_handler, err_handler)

    lsock = init_listen()


actor main(env):
    port = int(env.argv[1])
    var t = None
    t = Tester(env, port)
