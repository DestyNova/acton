actor Tester(env, port):
    var client = None
    var lsock = None
    var i = 0

    def init_listen():
        s = env.listen(port, connect_handler, sock_err_handler)
        return s

    def sock_err_handler():
        print("Error with our listening socket, attempting to re-establish listening socket")
        lsock = init_listen()

    def recv_handler(msg):
        print("RECV", msg)
        if msg == "GET":
            if client is not None:
                client.write(str(i))
        if msg == "INC":
            i += 1
            if client is not None:
                client.write("OK")

    def err_handler(msg):
        pass

    def connect_handler(conn):
        if conn is not None:
            print("Got connection")
            client = conn
            conn.on_receipt(recv_handler, err_handler)
        else:
            raise Exception("Unable to bind")

    lsock = init_listen()


actor main(env):
    port = int(env.argv[1])
    var t = None
    t = Tester(env, port)
